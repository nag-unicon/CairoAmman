**-----------------------------------------------------------------------------------
* <Rating>-12</Rating>
*-----------------------------------------------------------------------------------
    SUBROUTINE CAB.ACCT.MOF.MSG.PROCESS(Y.MOF.ACCOUNT)
*-----------------------------------------------------------------------------------
* Subroutine Type : BATCH ROUTINE
* Attached to     :
* Attached as     :
* Primary Purpose :
*
* Incoming:
* ---------
*
*
* Outgoing:
* ---------
*
*
* Error Variables:
* ----------------
*
*
*-----------------------------------------------------------------------------------
* Modification History:
*
*-----------------------------------------------------------------------------------
    $INSERT I_COMMON
    $INSERT I_EQUATE
    $INSERT I_GTS.COMMON
    $INSERT I_F.FUNDS.TRANSFER
    $INSERT I_F.CAB.MOF.ACCT.PARAM
    $INSERT I_F.CAB.MOF.PARAMETER
    $INSERT I_F.ACCOUNT
    $INSERT I_CAB.ACCT.MOF.MSG.PROCESS.COMMON
    $INSERT I_F.EB.FREE.MESSAGE
    $INSERT I_F.CAB.MOF.ACCT.LOG.TODAY
    $INSERT I_F.DATES
    $INSERT I_F.DE.MT101.REQUEST

    GOSUB PRE.PROCESS
    IF Y.PROCESS.FLAG THEN
        GOSUB PROCESS
    END ELSE

    END

    RETURN

********
PROCESS:
********
    Y.CURR.APP = ''
    R.MOF.TRANSACTION = ''
    Y.ACCOUNT.REC = ''
    IF Y.WORKING.BALANCE EQ '' THEN
        Y.WORKING.BALANCE = 0
    END
    IF Y.WORKING.BALANCE GT 0 THEN
        Y.CURR.APP = "FUNDS.TRANSFER"
        GOSUB FORM.OFS.MESSAGE.FT
    END ELSE
        IF Y.MOF.ACCOUNT.TYPE EQ 'REVENUE' THEN
            GOSUB LOG.EXCEPTION
        END ELSE
            IF Y.WORKING.BALANCE LT 0  AND R.CAB.MOF.ACCT.PARAM<PARAM.MOF.RECOVER.SUS.ACCT> THEN
                Y.MOF.PARAM.ACCOUNT.TEMP = ''
                Y.MOF.ACCOUNT.TEMP = ''
                Y.WORKING.BALANCE = ABS(Y.WORKING.BALANCE)
*                Y.CURR.APP = "DE.MT101.REQUEST"
*                GOSUB FORM.OFS.MESSAGE.FM
                Y.CURR.APP = "FUNDS.TRANSFER"
                Y.MOF.TXN.TYPE = "ACMI"
                Y.MOF.ACCOUNT.TEMP = Y.MOF.ACCOUNT
                Y.MOF.PARAM.ACCOUNT.TEMP = Y.MOF.PARAM.ACCOUNT
                Y.MOF.ACCOUNT = R.CAB.MOF.ACCT.PARAM<PARAM.MOF.RECOVER.SUS.ACCT>
                Y.MOF.PARAM.ACCOUNT = Y.MOF.ACCOUNT.TEMP
                Y.MOF.BFD.BEN = ''
                Y.ACCT.SHORT.TILE = ''
                Y.ACCT.SHORT.TITLE = ''
                GOSUB FORM.OFS.MESSAGE.FT
                Y.MOF.ACCOUNT = Y.MOF.ACCOUNT.TEMP
                Y.MOF.PARAM.ACCOUNT = Y.MOF.PARAM.ACCOUNT.TEMP
            END
        END
    END

    RETURN

********************
FORM.OFS.MESSAGE.FM:
********************

    Y.ACCOUNT.REC=''
    R.FM.VALUES=''
*    R.FM.VALUES<REQ.RECEIVER.101> = 'SW-CBJOJOAXXXX'        ;*'SW-':Y.MOF.DE.BIC
*    R.FM.VALUES<REQ.SENDERS.REF> = 'DD'
*    R.FM.VALUES<REQ.MSG.INDEX.TOT> = '1/2'
    Y.ACCOUNT.REC = Y.MOF.ACCOUNT
    GOSUB GET.ACCOUNT.RECORD
    R.FM.VALUES<REQ.ORD.CUST.A> = R.ACCOUNT.REC<AC.CUSTOMER>
    IF Y.IBAN.ACCT.NO THEN
        R.FM.VALUES<REQ.ORD.CUST.ACC.A> = Y.IBAN.ACCT.NO
    END ELSE
        R.FM.VALUES<REQ.ORD.CUST.ACC.A> = Y.MOF.PARAM.ACCOUNT
    END
    Y.ACCOUNT.REC = Y.MOF.PARAM.ACCOUNT
    GOSUB GET.ACCOUNT.RECORD
*    R.FM.VALUES<REQ.ACC.SERV.INS.A> = R.ACCOUNT.REC<AC.CUSTOMER>
*    R.FM.VALUES<REQ.ACC.SERV.ACC.A> = 'CBJOJOAXXXX'
    R.FM.VALUES<REQ.REQ.EXEC.DATE> = TODAY
    R.FM.VALUES<REQ.TRANS.REF> = Y.MOF.ACCOUNT
    R.FM.VALUES<REQ.TXN.CCY.AMT> = Y.CURRENCY:Y.WORKING.BALANCE
*    R.FM.VALUES<REQ.BEN.CUST> = R.ACCOUNT.REC<AC.CUSTOMER>
*    R.FM.VALUES<REQ.BEN.ACCT.NO> = Y.MOF.ACCOUNT
*    R.FM.VALUES<REQ.CHG.CODE> = "OUR"
*    R.FM.VALUES<REQ.CREATE.MT101> = "YES"
    R.MOF.TRANSACTION = R.FM.VALUES
    GOSUB BUILD.MOF.OFS.MSG
    RETURN

*************
LOG.EXCEPTION:
*************
    Y.CAB.MOF.ACCT.LOG.TODAY=''
    R.CAB.MOF.ACCT.LOG.TODAY=''
    E.CAB.MOF.ACCT.LOG.TODAY=''
    Y.ERR.MESSAGE = "PARAMETER ERROR"
    MSG.STATUS = "ERROR"
    R.CAB.MOF.ACCT.LOG.TODAY<MOF.LOG.TXN.DATE> = TODAY
    R.CAB.MOF.ACCT.LOG.TODAY<MOF.LOG.MOF.STATUS> = MSG.STATUS
    R.CAB.MOF.ACCT.LOG.TODAY<MOF.LOG.MOF.TXN> = Y.CAB.MOF.ACCT.LOG.TODAY
    R.CAB.MOF.ACCT.LOG.TODAY<MOF.LOG.MOF.MESSAGE> = Y.ERR.MESSAGE
    R.CAB.MOF.ACCT.LOG.TODAY<MOF.LOG.MOF.RES.MSG> = Y.ERR.MESSAGE
    CALL F.WRITE(FN.CAB.MOF.ACCT.LOG.TODAY,Y.CAB.MOF.ACCT.LOG.TODAY,R.CAB.MOF.ACCT.LOG.TODAY)

    RETURN


********************
FORM.OFS.MESSAGE.FT:
********************

    R.FT.VALUES = ''
    R.FT.VALUES<FT.TRANSACTION.TYPE> = Y.MOF.TXN.TYPE
    R.FT.VALUES<FT.DEBIT.ACCT.NO> = Y.MOF.ACCOUNT
    R.FT.VALUES<FT.BEN.ACCT.NO> = Y.MOF.BFD.BEN
    R.FT.VALUES<FT.DEBIT.CURRENCY> =  Y.CURRENCY
    R.FT.VALUES<FT.DEBIT.VALUE.DATE> = TODAY
    R.FT.VALUES<FT.CREDIT.ACCT.NO> = Y.MOF.PARAM.ACCOUNT
    R.FT.VALUES<FT.CREDIT.CURRENCY> = Y.MOF.PARAM.CURRENCY
    R.FT.VALUES<FT.CREDIT.AMOUNT> = Y.WORKING.BALANCE
    R.FT.VALUES<FT.CREDIT.VALUE.DATE> = TODAY
    R.FT.VALUES<FT.PROCESSING.DATE> = TODAY
    R.FT.VALUES<FT.BEN.CUSTOMER> = Y.ACCT.SHORT.TITLE
    R.FT.VALUES<FT.LOCAL.REF,PURPOSE.POS> = "0902"
    R.MOF.TRANSACTION =  R.FT.VALUES
    GOSUB BUILD.MOF.OFS.MSG

    RETURN

******************
BUILD.MOF.OFS.MSG:
******************

    Y.OFS.MESSAGE = ''
    OFS.FUNCTION = 'I' ; PROCESS = "PROCESS" ; GTSMODE = '' ; NO.OF.AUTH = '' ; OFS.RECORD = '' ; Y.OFS.APP.VERSION = Y.CURR.APP:Y.MOF.PARAM.OFS.VERSION
    TRANSACTION.ID = ''
    CALL OFS.BUILD.RECORD(Y.CURR.APP,OFS.FUNCTION,PROCESS,Y.OFS.APP.VERSION,GTSMODE,NO.OF.AUTH,TRANSACTION.ID,R.MOF.TRANSACTION,Y.OFS.MESSAGE)
    OFS.MSG = Y.OFS.MESSAGE
    COMMA.CNT = DCOUNT(OFS.MSG,',')
    OFS.PART1 = FIELD(OFS.MSG,',',1,2)
    OFS.PART2 = FIELD(OFS.MSG,',',3)
    OFS.PART3 = FIELD(OFS.MSG,',',4,COMMA.CNT)
    USER.DET.PART2 = FIELD(OFS.PART2,'/',4,7)
    USER.DET.PART1 = Y.MOF.PARAM.OFS.USER:'/':Y.MOF.PARAM.OFS.PASSWORD:'/':Y.MOF.PARAM.OFS.COMPANY
    USER.DET = USER.DET.PART1:USER.DET.PART2
    FINAL.OFS.MSG = OFS.PART1:',':USER.DET:',':OFS.PART3
    GOSUB RAISE.OFS.MSG

    RETURN

**************
RAISE.OFS.MSG:
**************
    OFS.MSG.ID = ''
    Y.OPTIONS = ''
    OFS.SOURCE.ID = Y.MOF.PARAM.OFS.SOURCE
    CALL OFS.POST.MESSAGE(FINAL.OFS.MSG,Y.OFS.MSG.ID ,OFS.SOURCE.ID, Y.OPTIONS)

    RETURN


PRE.PROCESS:
*********************
    Y.PROCESS.FLAG = ''
    Y.ACCOUNT = Y.MOF.ACCOUNT
    Y.CAB.MOF.ACCT.PARAM = Y.MOF.ACCOUNT
    R.CAB.MOF.ACCT.PARAM=''

    CALL F.READ(FN.CAB.MOF.ACCT.PARAM,Y.CAB.MOF.ACCT.PARAM,R.CAB.MOF.ACCT.PARAM,F.CAB.MOF.ACCT.PARAM,E.CAB.MOF.ACCT.PARAM)
    IF R.CAB.MOF.ACCT.PARAM THEN
        Y.MOF.ACCOUNT.TYPE = R.CAB.MOF.ACCT.PARAM<PARAM.MOF.ACCT.TYPE>
        Y.MOF.BFD.BEN = R.CAB.MOF.ACCT.PARAM<PARAM.MOF.BFD.IBAN>
        Y.MOF.DE.BIC  = R.CAB.MOF.ACCT.PARAM<PARAM.MOF.MOF.BIC.CODE>
        GOSUB GET.PARAM.DETAILS
    END

    R.ACCOUNT = ''
    E.ACCOUNT = ''
    Y.WORKING.BALANCE = ''
    Y.ACCT.SHORT.TITLE = ''
    CALL F.READ(FN.ACCOUNT,Y.ACCOUNT,R.ACCOUNT,F.ACCOUNT,E.ACCOUNT)

    IF R.ACCOUNT THEN
        IF Y.MONTHEND.FLAG THEN
            Y.WORKING.BALANCE = R.ACCOUNT<AC.ONLINE.ACTUAL.BAL>
        END ELSE
            Y.WORKING.BALANCE = R.ACCOUNT<AC.WORKING.BALANCE>
        END

        Y.CURRENCY = R.ACCOUNT<AC.CURRENCY>
        Y.ACCT.CO.CODE = R.ACCOUNT<AC.CO.CODE>
        Y.ACCT.SHORT.TITLE = R.ACCOUNT<AC.SHORT.TITLE,1>
    END

    RETURN

*****************
GET.PARAM.DETAILS:
*****************
    Y.MOF.POS = ''
    Y.MOF.TXN.TYPE=''
    LOCATE Y.MOF.ACCOUNT.TYPE IN Y.MOF.PARAM.ACCOUNT.TYPE<1,1> SETTING Y.MOF.POS THEN
        Y.PROCESS.FLAG = 1
        CONVERT VM TO FM IN Y.MOF.PARAM.TRANSACTION.TYPE
        Y.MOF.TXN.TYPE = Y.MOF.PARAM.TRANSACTION.TYPE<Y.MOF.POS>
    END

    RETURN
*******************
GET.ACCOUNT.RECORD:
*******************
    E.ACCOUNT.REC = ''
    R.ACCOUNT.REC = ''
    Y.IBAN.ACCT.NO = '' ; IBAN.POS = ''
    CALL F.READ(FN.ACCOUNT,Y.ACCOUNT.REC,R.ACCOUNT.REC,F.ACCOUNT,E.ACCOUNT.REC)
    LOCATE "IBAN" IN R.ACCOUNT.REC<AC.ALT.ACCT.TYPE,1> SETTING IBAN.POS THEN
        Y.IBAN.ACCT.NO = R.ACCOUNT.REC<AC.ALT.ACCT.ID,IBAN.POS>
    END
    RETURN

END
