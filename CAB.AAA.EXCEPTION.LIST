    SUBROUTINE CAB.AAA.EXCEPTION.LIST(RET.ARRAY)


    $INSERT I_COMMON
    $INSERT I_EQUATE
    $INSERT I_ENQUIRY.COMMON
    $INSERT I_F.AA.ARRANGEMENT.ACTIVITY

    GOSUB INIT
    GOSUB SEL.DATA
    RETURN

INIT:

    FN.AAA = 'F.AA.ARRANGEMENT.ACTIVITY$NAU'
    F.AAA =''
    CALL OPF(FN.AAA,F.AAA)

    SEL.TEXT = '';

    LOCATE 'BRANCH.NAME' IN ENQ.SELECTION<2,1> SETTING CO.POS THEN
        BR.CODE = ENQ.SELECTION<4,CO.POS>
        SEL.TEXT<-1> = ' AND CO.CODE EQ ':BR.CODE
    END


    LOCATE 'ARRANGEMENT.ID' IN ENQ.SELECTION<2,1> SETTING ARR.POS THEN
        ARR.ID = ENQ.SELECTION<4,ARR.POS>
        SEL.TEXT<-1> = ' AND ARRANGEMENT EQ ' : ARR.ID
    END

    LOCATE 'CUSTOMER.NO' IN ENQ.SELECTION<2,1> SETTING CUS.POS THEN
        CUS.ID = ENQ.SELECTION<4,CUS.POS>
        SEL.TEXT<-1> = ' AND CUSTOMER EQ ':CUS.ID
    END

    LOCATE 'ACTIVITY.ID' IN ENQ.SELECTION<2,1> SETTING ACT.POS THEN
        ACT.ID = ENQ.SELECTION<4,ACT.POS>
        SEL.TEXT<-1> = ' AND MASTER.AAA EQ ': ACT.ID
    END

    CONVERT FM TO ' ' IN SEL.TEXT

    RETURN

SEL.DATA:

    IF SEL.TEXT EQ '' THEN
        SEL.CMD = 'SELECT ':FN.AAA :' WITH @ID EQ MASTER.AAA BY CO.CODE BY EFFECTIVE.DATE'
    END ELSE
        SEL.CMD = 'SELECT ':FN.AAA :' WITH @ID EQ MASTER.AAA':SEL.TEXT:' BY CO.CODE BY EFFECTIVE.DATE'
    END

    SEL.LIST = '';
    CALL EB.READLIST(SEL.CMD,SEL.LIST,'',NO.OF.REC,SEL.ERR)

    RET.ARRAY = SEL.LIST
    RETURN
END
